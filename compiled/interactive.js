(function(){function error(err){stdout.write(err.stack||""+err),stdout.write("\n")}function autocomplete(text){return completeAttribute(text)||completeVariable(text)||[[],text]}function completeAttribute(text){var match,all,obj,prefix,candidates,key,ki$1,kobj$1,completions;if(match=text.match(ACCESSOR)){all=match[0],obj=match[1],prefix=match[2];try{obj=Script.runInThisContext(obj)}catch(e){return}if(null==obj)return;for(obj=Object(obj),candidates=Object.getOwnPropertyNames(obj),obj=Object.getPrototypeOf(obj);obj;){for(kobj$1=Object.getOwnPropertyNames(obj),ki$1=0;kobj$1.length>ki$1;ki$1++)key=kobj$1[ki$1],k$indexof.call(candidates,key)>=0?void 0:candidates.push(key);obj=Object.getPrototypeOf(obj)}return completions=getCompletions(prefix,candidates),[completions,prefix]}}function completeVariable(text){var free,vars,keywords,r,ki$2,kobj$2,candidates,key,ki$3,kobj$3,completions;if(free=null!=text.match(SIMPLEVAR)?text.match(SIMPLEVAR)[1]:void 0,""===text&&(free=""),null!=free){for(vars=Script.runInThisContext("Object.getOwnPropertyNames(Object(this))"),keywords=[],kobj$2=KAL_KEYWORDS,ki$2=0;kobj$2.length>ki$2;ki$2++)r=kobj$2[ki$2],"__"!==r.slice(0,2)?keywords.push(r):void 0;for(candidates=vars,kobj$3=keywords,ki$3=0;kobj$3.length>ki$3;ki$3++)key=kobj$3[ki$3],k$indexof.call(candidates,key)>=0?void 0:candidates.push(key);return completions=getCompletions(free,candidates),[completions,free]}}function getCompletions(prefix,candidates){var rv,el,ki$4,kobj$4;for(rv=[],kobj$4=candidates,ki$4=0;kobj$4.length>ki$4;ki$4++)el=kobj$4[ki$4],0===el.indexOf(prefix)?rv.push(el):void 0;return rv}function run(buffer){var code,_,returnValue;if(buffer=buffer.replace(/(^|[\r\n]+)(\s*)##?(?:[^#\r\n][^\r\n]*|)($|[\r\n])/,"$1$2$3"),buffer=buffer.replace(/[\r\n]+$/,""),multilineMode)return backlog+=""+buffer+"\n",repl.setPrompt(REPL_PROMPT_CONTINUATION),repl.prompt(),void 0;if(!(""+buffer).trim()&&!backlog)return repl.prompt(),void 0;if(backlog+=buffer,code=backlog,"\\"===code[code.length-1])return backlog=""+backlog.slice(0,-1)+"\n",repl.setPrompt(REPL_PROMPT_CONTINUATION),repl.prompt(),void 0;repl.setPrompt(REPL_PROMPT),backlog="",null==sandbox&&(sandbox=Kal.makeSandbox());try{_=global._,returnValue=Kal.eval(code,{filename:"repl",modulename:"repl",bare:!0,sandbox:sandbox}),void 0===returnValue&&(global._=_),repl.output.write(""+inspect(returnValue,!1,2,enableColors)+"\n")}catch(err){error(err)}repl.prompt()}var stdin,stdout,Kal,readline,util,inspect,vm,Script,Module,KAL_KEYWORDS,REPL_PROMPT,REPL_PROMPT_MULTILINE,REPL_PROMPT_CONTINUATION,enableColors,ACCESSOR,SIMPLEVAR,backlog,sandbox,pipedInput,repl,multilineMode,k$indexof=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};stdin=process.openStdin(),stdout=process.stdout,Kal=require("./kal"),readline=require("readline"),util=require("util"),inspect=util.inspect,vm=require("vm"),Script=vm.Script,Module=require("module"),KAL_KEYWORDS=require("./grammar").KEYWORDS,REPL_PROMPT="kal> ",REPL_PROMPT_MULTILINE="---> ",REPL_PROMPT_CONTINUATION="...> ",enableColors=!1,"win32"!==process.platform&&(enableColors=!process.env.NODE_DISABLE_COLORS),ACCESSOR=/\s*([\w\.]+)(?:\.(\w*))$/,SIMPLEVAR=/(\w+)$/i,process.on("uncaughtException",error),backlog="",sandbox=global,stdin.readable&&stdin.isRaw?(pipedInput="",repl={},repl.prompt=function(){stdout.write(this._prompt)},repl.setPrompt=function(p){this._prompt=p},repl.input=stdin,repl.output=stdout,repl.on=function(){},stdin.on("data",function(chunk){var nlre,lines,line,ki$5,kobj$5;if(pipedInput+=chunk,nlre=/\n/,nlre.test(pipedInput))for(lines=pipedInput.split("\n"),pipedInput=lines[lines.length-1],kobj$5=lines.slice(1,-1),ki$5=0;kobj$5.length>ki$5;ki$5++)line=kobj$5[ki$5],line&&(stdout.write(""+line+"\n"),run(line,sandbox))}),stdin.on("end",function(){var line,ki$6,kobj$6;for(kobj$6=pipedInput.trim().split("\n"),ki$6=0;kobj$6.length>ki$6;ki$6++)line=kobj$6[ki$6],line&&(stdout.write(""+line+"\n"),run(line,sandbox));stdout.write("\n"),process.exit(0)})):3>readline.createInterface.length?(repl=readline.createInterface(stdin,autocomplete),stdin.on("data",function(buffer){repl.write(buffer)})):repl=readline.createInterface(stdin,stdout,autocomplete),multilineMode=!1,repl.input.on("keypress",function(char,key){var cursorPos,newPrompt;key&&key.ctrl&&!key.meta&&!key.shift&&"v"===key.name&&(cursorPos=repl.cursor,repl.output.cursorTo(0),repl.output.clearLine(1),multilineMode=!multilineMode,!multilineMode&&backlog?repl._line():void 0,backlog="",newPrompt=multilineMode?REPL_PROMPT_MULTILINE:REPL_PROMPT,repl.setPrompt(newPrompt),repl.prompt(),repl.cursor=cursorPos,repl.output.cursorTo(newPrompt.length+repl.cursor))}),repl.input.on("keypress",function(char,key){multilineMode&&repl.line&&key&&key.ctrl&&!key.meta&&!key.shift&&"d"===key.name&&(multilineMode=!1,repl._line())}),repl.on("attemptClose",function(){return multilineMode?(multilineMode=!1,repl.output.cursorTo(0),repl.output.clearLine(1),repl._onLine(repl.line),void 0):(backlog||repl.line?(backlog="",repl.historyIndex=-1,repl.setPrompt(REPL_PROMPT),repl.output.write("\n(^C again to quit)"),repl.line="",repl._line(repl.line)):repl.close(),void 0)}),repl.on("close",function(){repl.output.write("\n"),repl.input.destroy()}),repl.on("line",run),repl.setPrompt(REPL_PROMPT),repl.prompt()})();